# Backend Requirements: User Credentials Export & Settings Tab Fixes

## Overview
Two critical issues need to be fixed in the Settings page backend:
1. **Export User Credentials as Word Document** (instead of Markdown)
2. **Empty Data Issues** in Users & Sections Tab

---

## ISSUE 1: Export User Credentials as Word Document

### Current Situation
- Endpoint: `GET /api/admin/testing/user-credentials-markdown`
- Returns: Markdown file download
- Problem: Markdown format is not user-friendly for documentation

### Required Change
**New Endpoint:** `GET /api/admin/testing/user-credentials-word`

### Specification

**Authorization:**
- Only `SOFTWARE_ADMIN` role should have access
- Return `403 Forbidden` for other roles

**Response Type:**
- Content-Type: `application/vnd.openxmlformats-officedocument.wordprocessingml.document`
- File download with appropriate headers

**Document Structure:**

```
Title: User Credentials for Testing
Generated: [Date and Time]

========================================

1. SOFTWARE_ADMIN Users
   â†’ Username: admin
   â†’ Password: [password]
   â†’ Role: SOFTWARE_ADMIN
   â†’ Status: Active
   â†’ Org Unit: (none)

2. SECTION_ADMIN Users

   Section: Emergency Department - Section A
   â†’ Username: sec_101_admin
   â†’ Password: [password]
   â†’ Role: SECTION_ADMIN
   â†’ Status: Active
   â†’ Parent Department: Emergency Department
   â†’ Parent Administration: Medical Administration

   [Repeat for each section admin...]

3. DEPARTMENT_ADMIN Users

   Department: Emergency Department
   â†’ Username: dept_42_admin
   â†’ Password: [password]
   â†’ Role: DEPARTMENT_ADMIN
   â†’ Status: Active
   â†’ Parent Administration: Medical Administration

   [Repeat for each department admin...]

4. ADMINISTRATION_ADMIN Users

   Administration: Medical Administration
   â†’ Username: admin_10_admin
   â†’ Password: [password]
   â†’ Role: ADMINISTRATION_ADMIN
   â†’ Status: Active

   [Repeat for each administration admin...]

========================================
Document generated by Complaints Management System
For testing purposes only - Keep secure
========================================
```

**Document Formatting:**
- **Title:** Bold, 16pt, centered
- **Section Headers (1., 2., 3., 4.):** Bold, 14pt
- **Org Unit Names:** Bold, 12pt
- **Field Labels (â†’):** Regular, 11pt
- **Values:** Regular, 11pt, with passwords in monospace font
- **Footer:** Centered, 10pt, italic

### Implementation Suggestions

**Python (using python-docx):**
```python
from docx import Document
from docx.shared import Pt, RGBColor
from docx.enum.text import WD_ALIGN_PARAGRAPH
from io import BytesIO
from fastapi.responses import StreamingResponse

@router.get("/api/admin/testing/user-credentials-word")
async def export_credentials_word(current_user: User = Depends(get_current_user)):
    # Authorization check
    if current_user.role != "SOFTWARE_ADMIN":
        raise HTTPException(status_code=403, detail="Only SOFTWARE_ADMIN can export credentials")
    
    # Create document
    doc = Document()
    
    # Title
    title = doc.add_heading("User Credentials for Testing", level=0)
    title.alignment = WD_ALIGN_PARAGRAPH.CENTER
    
    # Generated timestamp
    timestamp = doc.add_paragraph(f"Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    timestamp.alignment = WD_ALIGN_PARAGRAPH.CENTER
    
    doc.add_paragraph("=" * 50)
    
    # Fetch users from database
    users = get_all_users_with_test_passwords()
    
    # Group by role
    role_groups = {
        "SOFTWARE_ADMIN": [],
        "SECTION_ADMIN": [],
        "DEPARTMENT_ADMIN": [],
        "ADMINISTRATION_ADMIN": []
    }
    
    for user in users:
        if user.role in role_groups:
            role_groups[user.role].append(user)
    
    # Add sections for each role
    for role, users_list in role_groups.items():
        if not users_list:
            continue
            
        doc.add_heading(f"{len(users_list)}. {role} Users", level=1)
        
        for user in users_list:
            # Org unit header if applicable
            if user.org_unit_name:
                p = doc.add_paragraph()
                run = p.add_run(f"{user.org_unit_type}: {user.org_unit_name}")
                run.bold = True
                run.font.size = Pt(12)
            
            # User details
            doc.add_paragraph(f"â†’ Username: {user.username}")
            
            # Password in monospace
            p = doc.add_paragraph("â†’ Password: ")
            run = p.add_run(user.test_password or "(not set)")
            run.font.name = "Courier New"
            
            doc.add_paragraph(f"â†’ Role: {user.role}")
            doc.add_paragraph(f"â†’ Status: {'Active' if user.is_active else 'Inactive'}")
            
            if user.parent_org_unit_name:
                doc.add_paragraph(f"â†’ Parent: {user.parent_org_unit_name}")
            
            doc.add_paragraph("")  # Blank line
    
    # Footer
    doc.add_paragraph("=" * 50)
    footer = doc.add_paragraph("Document generated by Complaints Management System\\nFor testing purposes only - Keep secure")
    footer.alignment = WD_ALIGN_PARAGRAPH.CENTER
    
    # Save to BytesIO
    file_stream = BytesIO()
    doc.save(file_stream)
    file_stream.seek(0)
    
    # Return as download
    filename = f"user_credentials_{datetime.now().strftime('%Y%m%d')}.docx"
    
    return StreamingResponse(
        file_stream,
        media_type="application/vnd.openxmlformats-officedocument.wordprocessingml.document",
        headers={
            "Content-Disposition": f"attachment; filename={filename}"
        }
    )
```

**Dependencies:**
```bash
pip install python-docx
```

### Frontend Integration (Already Implemented)
The frontend will call a new API function:

```javascript
// In src/api/adminUsers.js - ADD THIS FUNCTION
export const exportCredentialsWord = async () => {
  try {
    const response = await apiClient.get("/api/admin/testing/user-credentials-word", {
      responseType: "blob",
    });
    
    // Create blob and download
    const blob = new Blob([response.data], { 
      type: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" 
    });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `user_credentials_${new Date().toISOString().split("T")[0]}.docx`;
    link.click();
    URL.revokeObjectURL(url);
    
    return { success: true };
  } catch (error) {
    console.error("Error exporting credentials as Word:", error);
    throw error;
  }
};
```

---

## ISSUE 2: Empty Data in Users & Sections Tab

### Problem Statement
Two issues are causing empty displays in the "Users & Sections (Testing)" tab:

1. **Empty Administration/Department Dropdowns:**
   - When clicking "ðŸ—ï¸ Create Section + Admin User"
   - Dropdowns show no options

2. **Empty User Credentials Table:**
   - "ðŸ‘¥ User Credentials" section shows "No users found" even when users exist

### Root Cause Analysis

**Issue 2.1: Empty Dropdowns**
- Frontend calls: `GET /api/admin/user-inventory`
- Expected response structure:
```json
{
  "org_units": [
    {
      "ID": 10,
      "Name": "Medical Administration",
      "Type": "ADMINISTRATION",
      "ParentID": null
    },
    {
      "ID": 42,
      "Name": "Emergency Department",
      "Type": "DEPARTMENT",
      "ParentID": 10
    },
    {
      "ID": 101,
      "Name": "Section A",
      "Type": "SECTION",
      "ParentID": 42
    }
  ]
}
```

**Required Fields:**
- `ID` (integer) - Primary key of org unit
- `Name` (string) - Display name
- `Type` (string) - One of: "ADMINISTRATION", "DEPARTMENT", "SECTION"
- `ParentID` (integer or null) - Parent org unit ID

**Frontend Code (for reference):**
```javascript
const loadOrgUnits = async () => {
  const data = await getUserInventory();
  const admins = data.org_units.filter((unit) => unit.Type === "ADMINISTRATION");
  const depts = data.org_units.filter((unit) => unit.Type === "DEPARTMENT");
  setAdministrations(admins);
  setDepartments(depts);
};
```

**Action Required:**
1. Verify endpoint returns `org_units` array
2. Verify each object has `ID`, `Name`, `Type`, `ParentID` fields
3. Verify `Type` values match exactly: "ADMINISTRATION", "DEPARTMENT", "SECTION"

---

**Issue 2.2: Empty User Credentials Table**
- Frontend calls: `GET /api/admin/testing/user-credentials`
- Expected response structure:
```json
{
  "users": [
    {
      "user_id": 1,
      "username": "admin",
      "role": "SOFTWARE_ADMIN",
      "is_active": true,
      "org_unit_id": null,
      "org_unit_name": null,
      "test_password": "secure_admin_password"
    },
    {
      "user_id": 2,
      "username": "sec_101_admin",
      "role": "SECTION_ADMIN",
      "is_active": true,
      "org_unit_id": 101,
      "org_unit_name": "Emergency - Section A",
      "test_password": "section_admin_password_xyz"
    }
  ]
}
```

**Required Fields:**
- `user_id` (integer) - Primary key
- `username` (string) - Login username
- `role` (string) - One of: "SOFTWARE_ADMIN", "SECTION_ADMIN", "DEPARTMENT_ADMIN", "ADMINISTRATION_ADMIN"
- `is_active` (boolean) - User active status
- `org_unit_id` (integer or null) - Associated org unit ID (null for SOFTWARE_ADMIN)
- `org_unit_name` (string or null) - Associated org unit name (null for SOFTWARE_ADMIN)
- `test_password` (string or null) - Plain text password for testing (âš ï¸ TESTING ONLY)

**Frontend Code (for reference):**
```javascript
const loadUsers = async () => {
  const data = await getUserCredentials();
  setUsers(data.users || []);
};

// Table displays:
// - user.username
// - user.role
// - user.org_unit_name || "(none)"
// - user.is_active
// - user.test_password || "(not set)"
```

**Action Required:**
1. Verify endpoint returns `users` array
2. Verify each user object has all required fields
3. Verify `test_password` field is included (this is a testing endpoint, so plain text is acceptable)
4. If no test_password exists, return `null` (frontend will show "(not set)")

---

### Testing Checklist

**Test 1: User Inventory Endpoint**
```bash
curl -X GET http://localhost:8000/api/admin/user-inventory \\
  -H "Cookie: session=YOUR_SESSION_COOKIE"
```

Expected:
- âœ… Returns 200 OK
- âœ… Response has `org_units` array
- âœ… Each object has `ID`, `Name`, `Type`, `ParentID`
- âœ… Types include "ADMINISTRATION", "DEPARTMENT", "SECTION"

**Test 2: User Credentials Endpoint**
```bash
curl -X GET http://localhost:8000/api/admin/testing/user-credentials \\
  -H "Cookie: session=YOUR_SESSION_COOKIE"
```

Expected:
- âœ… Returns 200 OK
- âœ… Response has `users` array
- âœ… Each user has: `user_id`, `username`, `role`, `is_active`, `org_unit_id`, `org_unit_name`, `test_password`
- âœ… Passwords are included (testing endpoint)

**Test 3: Word Export Endpoint**
```bash
curl -X GET http://localhost:8000/api/admin/testing/user-credentials-word \\
  -H "Cookie: session=YOUR_SESSION_COOKIE" \\
  -o credentials.docx
```

Expected:
- âœ… Returns 200 OK
- âœ… Downloads a valid .docx file
- âœ… File opens in Microsoft Word / LibreOffice
- âœ… Contains all users grouped by role
- âœ… Passwords are displayed in monospace font

---

## Summary

### Changes Required:

1. **New Endpoint:** `GET /api/admin/testing/user-credentials-word`
   - Exports user credentials as Word document (.docx)
   - Formatted with headers, bold text, proper grouping
   - Includes all testing passwords

2. **Fix Endpoint:** `GET /api/admin/user-inventory`
   - Ensure returns `org_units` array
   - Verify field names: `ID`, `Name`, `Type`, `ParentID`
   - Verify Type values: "ADMINISTRATION", "DEPARTMENT", "SECTION"

3. **Fix Endpoint:** `GET /api/admin/testing/user-credentials`
   - Ensure returns `users` array
   - Verify all fields are present: `user_id`, `username`, `role`, `is_active`, `org_unit_id`, `org_unit_name`, `test_password`
   - Include plain text `test_password` field (acceptable for testing endpoint)

### Dependencies:
```bash
pip install python-docx
```

### Priority:
- **High:** Issues #2.1 and #2.2 (Empty data) - Blocking frontend functionality
- **Medium:** Issue #1 (Word export) - Enhancement, Markdown export still works

---

**Please implement these changes and confirm when ready for frontend testing.**
